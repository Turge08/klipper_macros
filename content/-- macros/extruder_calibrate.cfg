[gcode_macro extruder_calibrate]
variable_rotation_distance: 0
variable_extrude_length: 100
variable_extrude_speed: 5 # mm/s
gcode:
    {% set measured_value = params.MEASURED | float %}
    {% if rotation_distance == 0 %}
        {% set rotation_distance = printer.configfile.settings.extruder.rotation_distance | float %}
    {% endif %}
    { action_respond_info("Current Rotation Distance: %f" % rotation_distance) }
    {% set new_rotation_distance = rotation_distance * measured_value / extrude_length | float %}
    { action_respond_info("New Rotation Distance: %f" % new_rotation_distance) }
    SET_GCODE_VARIABLE MACRO=extruder_calibrate VARIABLE=rotation_distance VALUE={new_rotation_distance}
    SET_EXTRUDER_ROTATION_DISTANCE EXTRUDER=extruder DISTANCE={new_rotation_distance}
    M83
    G1 E{extrude_length} F{extrude_speed * 60}
    { action_respond_info("Measure the extruded length and re-run this macro:") }
    { action_respond_info("EXTRUDER_CALIBRATE MEASURED=xx") }
