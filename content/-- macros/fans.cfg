[gcode_macro M106]
rename_existing: G106
gcode:
    {% set fan_number = params.P | default(0) | int %}
    {% set fan_name = printer["gcode_macro _fans"].fans[fan_number] %}
    {% set speed = params.S | default(255) | int %}
    {% if fan_number == 0 %}
        G106 S{speed}
    {% elif fan_name != '' or fan_name == null %}
        SET_FAN_SPEED FAN={fan_name} SPEED={speed/255}
    {% else %}
        { action_respond_info("Fan %i not defined" % fan_number) }
    {% endif %}

[gcode_macro M107]
rename_existing: G107
gcode:
    G107 S0
    {% set fan_name = printer["gcode_macro _fans"].fans[2] %}
    {% if fan_name != '' %}
        SET_FAN_SPEED FAN={fan_name} SPEED=0
    {% endif %}