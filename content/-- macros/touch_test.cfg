[gcode_macro touch_test]
gcode:
    {% set iterations = 10 %}

    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}

    {% if printer.quad_gantry_level %}
        {% set bed_levelling = printer.quad_gantry_level %}
    {% endif %}
    {% if printer.z_tilt %}
        {% set bed_levelling = printer.z_tilt %}
    {% endif %}
    {% if bed_levelling and printer["print_setting bed_level"].value == true %}
        { action_respond_info("**** Bed Levelling") }
        {% if bed_levelling.applied == false %}
            {% if printer.quad_gantry_level %}
                { action_respond_info("Performing Quad Gantry Level") }
                QUAD_GANTRY_LEVEL
            {% endif %}
            {% if printer.z_tilt %}
                { action_respond_info("Performing Z Tilt Adjust") }
                Z_TILT_ADJUST
            {% endif %}
            SET_GCODE_VARIABLE MACRO=BED_MESH_CALIBRATE VARIABLE=last_x_max VALUE=0
        {% else %}
            { action_respond_info("Skipping Bed Levelling since it was already performed") }
        {% endif %}
    {% endif %}

    {% for i in range(iterations) %}
        CARTOGRAPHER_TOUCH
    {% endfor %}